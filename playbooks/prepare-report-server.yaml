---
- name: prepare report-server
  hosts: aap-db
  become: true
  vars:
    web_port: 80
  tasks:
 
  - name: install apache
    become: true
    yum:
      name: httpd
      state: present

  - name: change apache to specified port
    become: true
    lineinfile:
      path: /etc/httpd/conf/httpd.conf
      regexp: '^Listen '
      insertafter: '^#Listen '
      line: 'Listen {{web_port}}'
 
  - name: Set nis_enabled flag on and keep it persistent across reboots
    become: true
    seboolean:
      name: nis_enabled
      state: true
      persistent: true

  - name: start httpd
    become: true
    service:
      name: httpd
      state: started

  - name: retrieve public IP address
    ansible.builtin.command: curl https://ifconfig.me
    register: report_server_ip
    ignore_errors: true

  - name: display link to inventory report
    debug:
      msg:
        - "Please go to http://{{ report_server_ip.stdout | default(ansible_fqdn) }}:{{ web_port }}"

